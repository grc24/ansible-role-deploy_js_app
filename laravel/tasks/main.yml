---
# tasks file for laravel

# Create Project folder
- name: Creates Project directory
  ansible.builtin.file:
    path: /home/{{ ansible_user }}/{{ project_name }}
    state: directory



# Clone repository
- name: Clone the repository
  git:
    repo: "{{ item.repository }}"
    dest: /home/{{ ansible_user }}/{{ project_name }}/{{ clone_directory }}
    version: "{{ item.branch_work }}"
    update: yes
    force: yes
  loop: "{{ project_directory_name }}"

  register: git_clone_result

- name: Display clone result
  debug:
    var: git_clone_result

  
# Docker Network
- name: Check if network exist
  command: docker network inspect {{ network_name }} 
  register: result
  ignore_errors: True



- name: Create Docker network
  command: docker network create {{ network_name }} 
  when: result is failed

- name: Creates docker entrypoint folder
  ansible.builtin.file:
    path: /home/{{ ansible_user }}/{{ project_name }}/{{ clone_directory }}/docker
    state: directory

- name: Copy entrypoint file into docker folder
  template:
    src: entrypoint.sh
    dest: /home/{{ ansible_user }}/{{ project_name }}/{{ clone_directory }}/docker/entrypoint.sh
    mode: '0755'

# Custome docker compose and env
- name: copy Dockerfile
  template:
    src: Dockerfile
    dest: /home/{{ ansible_user }}/{{ project_name }}/{{ clone_directory }}/Dockerfile


- name: copy env
  template:
    src: env 
    dest: /home/{{ ansible_user }}/{{ project_name }}/{{ clone_directory }}/env
  loop: "{{ project_directory_name }}"


- name: Set lowercase project name
  set_fact:
    docker_image_name: "{{ project_name | lower }}:api"

- name: Check if image already exist
  command: docker image inspect {{ docker_image_name }} 
  register: result_image
  ignore_errors: True

 
# build the app
- name: Build Docker image
  command:  docker build -t {{ docker_image_name }} /home/{{ ansible_user }}/{{ project_name }}/{{ clone_directory }} 
  args:
    chdir: /home/{{ ansible_user }}/{{ project_name }}/{{ clone_directory }} 
  when: result_image is failed
  register: output

- name: view image 
  debug:
    var: output
  
- name: Update file docker compose
  template:
    src:  docker-compose.yml
    dest: /home/{{ ansible_user }}/{{ project_name }}/{{ clone_directory }}/docker-compose.yml
  loop: "{{ project_directory_name }}"

# Up application
- name: Start Docker Compose application
  command: docker compose -f /home/{{ ansible_user }}/{{ project_name }}/{{ clone_directory }}/docker-compose.yml  up -d
  args:
    chdir: /home/{{ ansible_user }}/{{ project_name }}/{{ clone_directory }}

    